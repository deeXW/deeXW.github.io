<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Map异同比较 | Dee Tech Docs</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/assets/css/0.styles.8bd7139f.css" as="style"><link rel="preload" href="/assets/js/app.964429b0.js" as="script"><link rel="preload" href="/assets/js/2.8644fcbd.js" as="script"><link rel="preload" href="/assets/js/21.e3c2fe27.js" as="script"><link rel="prefetch" href="/assets/js/10.afff0a28.js"><link rel="prefetch" href="/assets/js/11.baf33c84.js"><link rel="prefetch" href="/assets/js/12.c2667b51.js"><link rel="prefetch" href="/assets/js/13.6b285a36.js"><link rel="prefetch" href="/assets/js/14.9f946e5b.js"><link rel="prefetch" href="/assets/js/15.9a7664bc.js"><link rel="prefetch" href="/assets/js/16.ce334161.js"><link rel="prefetch" href="/assets/js/17.ad75315d.js"><link rel="prefetch" href="/assets/js/18.a998e671.js"><link rel="prefetch" href="/assets/js/19.8b3e32be.js"><link rel="prefetch" href="/assets/js/20.6867801b.js"><link rel="prefetch" href="/assets/js/22.f0d445e1.js"><link rel="prefetch" href="/assets/js/23.aece5282.js"><link rel="prefetch" href="/assets/js/24.33541ed9.js"><link rel="prefetch" href="/assets/js/25.dc85ff2b.js"><link rel="prefetch" href="/assets/js/3.3c19242c.js"><link rel="prefetch" href="/assets/js/4.8c10166e.js"><link rel="prefetch" href="/assets/js/5.cb84afd7.js"><link rel="prefetch" href="/assets/js/6.7cf8f0df.js"><link rel="prefetch" href="/assets/js/7.874c6bda.js"><link rel="prefetch" href="/assets/js/8.82ff5f3c.js"><link rel="prefetch" href="/assets/js/9.8514ea9b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8bd7139f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Dee Tech Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/git/" class="nav-link">Git</a></div><div class="nav-item"><a href="/java/basic/" class="nav-link">Java</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/deeXW/z-note-book" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/git/" class="nav-link">Git</a></div><div class="nav-item"><a href="/java/basic/" class="nav-link">Java</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/deeXW/z-note-book" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础牢固</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>集合</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/collection/equals-hashcode.html" class="sidebar-link">equals()与hashCode()方法详解</a></li><li><a href="/java/collection/hashMap-deep.html" class="sidebar-link">HashMap实现原理及源码分析</a></li><li><a href="/java/collection/list-remove.html" class="sidebar-link">删除list元素的四种方法(remove)</a></li><li><a href="/java/collection/map.html" class="active sidebar-link">Map异同比较</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/collection/map.html#_0-前言" class="sidebar-link">0. 前言</a></li><li class="sidebar-sub-header"><a href="/java/collection/map.html#_1-hashmap概述" class="sidebar-link">1. HashMap概述</a></li><li class="sidebar-sub-header"><a href="/java/collection/map.html#_2-hashmap初始化" class="sidebar-link">2. HashMap初始化</a></li><li class="sidebar-sub-header"><a href="/java/collection/map.html#_3-hashmap的put操作" class="sidebar-link">3. HashMap的put操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/collection/map.html#_3-1-put进的key为null" class="sidebar-link">3.1 put进的key为null</a></li><li class="sidebar-sub-header"><a href="/java/collection/map.html#_3-2-put进的key不为null" class="sidebar-link">3.2 put进的key不为null</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/collection/map.html#_4-hashmap的get操作" class="sidebar-link">4. HashMap的get操作</a></li><li class="sidebar-sub-header"><a href="/java/collection/map.html#_5-hashmap和hashtable的对比" class="sidebar-link">5. HashMap和HashTable的对比</a></li><li class="sidebar-sub-header"><a href="/java/collection/map.html#_6-hashtable和concurrenthashmap的对比" class="sidebar-link">6. HashTable和ConCurrentHashMap的对比</a></li><li class="sidebar-sub-header"><a href="/java/collection/map.html#_7-hashmap和concurrenthashmap的对比" class="sidebar-link">7. HashMap和ConCurrentHashMap的对比</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="map异同比较"><a href="#map异同比较" aria-hidden="true" class="header-anchor">#</a> Map异同比较</h1> <blockquote><p>HashMap、HashTable以及ConCurrentHashMap异同比较</p></blockquote> <h2 id="_0-前言"><a href="#_0-前言" aria-hidden="true" class="header-anchor">#</a> 0. 前言</h2> <p>HashMap和HashTable的区别一种比较简单的回答是：</p> <p>（1）HashMap是非线程安全的，HashTable是线程安全的。</p> <p>（2）HashMap的键和值都允许有null存在，而HashTable则都不行。</p> <p>（3）因为线程安全、哈希效率的问题，HashMap效率比HashTable的要高。</p> <p>但是如果继续追问：Java中的另一个线程安全的与HashMap功能极其类似的类是什么？</p> <p>同样是线程安全，它与HashTable在线程同步上有什么不同？带着这些问题，开始今天的文章。</p> <h2 id="_1-hashmap概述"><a href="#_1-hashmap概述" aria-hidden="true" class="header-anchor">#</a> 1. HashMap概述</h2> <p>Java中的数据存储方式有两种结构，一种是数组，另一种就是链表，前者的特点是连续空间，寻址迅速，但是在增删元素的时候会有较大幅度的移动，所以数组的特点是查询速度快，增删较慢。</p> <p>而链表由于空间不连续，寻址困难，增删元素只需修改指针，所以链表的特点是查询速度慢、增删快。</p> <p>那么有没有一种数据结构来综合一下数组和链表以便发挥他们各自的优势？答案就是哈希表。哈希表的存储结构如下图所示：</p> <p><img src="https://img-blog.csdn.net/20160925154951217?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p> <p>从上图中，我们可以发现哈希表是由数组+链表组成的，一个长度为16的数组中，每个元素存储的是一个链表的头结点，通过功能类似于hash(key.hashCode())%len的操作，获得要添加的元素所要存放的的数组位置。</p> <p>HashMap的哈希算法实际操作是通过位运算，比取模运算效率更高，同样能达到使其分布均匀的目的，后面会介绍。</p> <p>键值对所存放的数据结构其实是HashMap中定义的一个Entity内部类，数组来实现的，属性有key、value和指向下一个Entity的next。</p> <h2 id="_2-hashmap初始化"><a href="#_2-hashmap初始化" aria-hidden="true" class="header-anchor">#</a> 2. HashMap初始化</h2> <p>HashMap有两种常用的构造方法：</p> <p>第一种是不需要参数的构造方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">//初始数组长度为16  </span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAXIMUM_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> <span class="token comment">//最大容量为2的30次方  </span>
	<span class="token comment">//装载因子用来衡量HashMap满的程度  </span>
	<span class="token comment">//计算HashMap的实时装载因子的方法为：size/capacity  </span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> DEFAULT_LOAD_FACTOR <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span> <span class="token comment">//装载因子  </span>
	  
	<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	    <span class="token keyword">this</span><span class="token punctuation">.</span>loadFactor <span class="token operator">=</span> DEFAULT_LOAD_FACTOR<span class="token punctuation">;</span>    
		threshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DEFAULT_INITIAL_CAPACITY <span class="token operator">*</span> DEFAULT_LOAD_FACTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	 	<span class="token comment">//默认数组长度为16   </span>
	     table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>DEFAULT_INITIAL_CAPACITY<span class="token punctuation">]</span><span class="token punctuation">;</span>  
	     <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	 <span class="token punctuation">}</span>   
</code></pre></div><p>第二种是需要参数的构造方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal initial capacity: &quot;</span> <span class="token operator">+</span> initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&gt;</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span>    
            initialCapacity <span class="token operator">=</span> MAXIMUM_CAPACITY<span class="token punctuation">;</span>    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadFactor <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token class-name">Float</span><span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>loadFactor<span class="token punctuation">)</span><span class="token punctuation">)</span>    
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal load factor: &quot;</span> <span class="token operator">+</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>    
  
        <span class="token comment">// Find a power of 2 &gt;= initialCapacity    </span>
         <span class="token keyword">int</span> capacity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
         <span class="token keyword">while</span> <span class="token punctuation">(</span>capacity <span class="token operator">&lt;</span> initialCapacity<span class="token punctuation">)</span>    
             capacity <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
     
         <span class="token keyword">this</span><span class="token punctuation">.</span>loadFactor <span class="token operator">=</span> loadFactor<span class="token punctuation">;</span>    
         threshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>capacity <span class="token operator">*</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>    
         table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>    
         <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
 	<span class="token punctuation">}</span>   
</code></pre></div><p>从源码可以看出，初始化的数组长度为capacity，capacity的值总是2的N次方，大小比第一个参数稍大或相等。</p> <h2 id="_3-hashmap的put操作"><a href="#_3-hashmap的put操作" aria-hidden="true" class="header-anchor">#</a> 3. HashMap的put操作</h2> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    
          <span class="token keyword">return</span> <span class="token function">putForNullKey</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
            <span class="token class-name">Object</span> k<span class="token punctuation">;</span>    
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
                <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>    
                 e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>    
                 e<span class="token punctuation">.</span><span class="token function">recordAccess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
                 <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>    
             <span class="token punctuation">}</span>    
         <span class="token punctuation">}</span>          
 		modCount<span class="token operator">++</span><span class="token punctuation">;</span>    
        <span class="token function">addEntry</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    
 	<span class="token punctuation">}</span>   
</code></pre></div><h3 id="_3-1-put进的key为null"><a href="#_3-1-put进的key为null" aria-hidden="true" class="header-anchor">#</a> 3.1 put进的key为null</h3> <p>从源码中可以看出，HashMap是允许key为null的，会调用putForNullKey()方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">private</span> <span class="token class-name">V</span> <span class="token function">putForNullKey</span><span class="token punctuation">(</span><span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	                <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>    
	                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>    
	                e<span class="token punctuation">.</span><span class="token function">recordAccess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	                <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>    
	            <span class="token punctuation">}</span>    
	        <span class="token punctuation">}</span>    
	         modCount<span class="token operator">++</span><span class="token punctuation">;</span>    
	         <span class="token function">addEntry</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    
	 <span class="token punctuation">}</span>   
	   
	<span class="token keyword">void</span> <span class="token function">addEntry</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> bucketIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	 <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>bucketIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>    
	     table<span class="token punctuation">[</span>bucketIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	     <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token operator">++</span> <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>    
	         <span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	 <span class="token punctuation">}</span>    
</code></pre></div><p>putForNullKey方法会遍历以table[0]为链表头的链表，如果存在key为null的KV，那么替换其value值并返回旧值。否则调用addEntry方法，这个方法也很简单，将[null,value]放在table[0]的位置，并将新加入的键值对封装成一个Entity对象，将其next指向原table[0]处的Entity实例。</p> <p>size表示HashMap中存放的所有键值对的数量。</p> <p>threshold = capacity*loadFactor，最后几行代码表示当HashMap的size大于threshold时会执行resize操作，将HashMap扩容为原来的2倍。扩容需要重新计算每个元素在数组中的位置，indexFor()方法中的table.length参数也证明了这一点。</p> <p>但是扩容是一个非常消耗性能的操作，所以如果我们已经预知HashMap中元素的个数，那么预设元素的个数能够有效的提高HashMap的性能。比如说我们有1000个元素，那么我们就该声明new HashMap(2048)，因为需要考虑默认的0.75的扩容因子和数组数必须是2的N次方。若使用声明new HashMap(1024)那么put过程中会进行扩容。</p> <h3 id="_3-2-put进的key不为null"><a href="#_3-2-put进的key不为null" aria-hidden="true" class="header-anchor">#</a> 3.2 put进的key不为null</h3> <p>将上述put方法中的相关代码复制一下方便查看：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	    <span class="token class-name">Object</span> k<span class="token punctuation">;</span>    
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	        <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>    
	        e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>    
	        e<span class="token punctuation">.</span><span class="token function">recordAccess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	        <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>    
	        <span class="token punctuation">}</span>    
	 <span class="token punctuation">}</span>          
	modCount<span class="token operator">++</span><span class="token punctuation">;</span>    
	<span class="token function">addEntry</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    
	<span class="token punctuation">}</span>  
</code></pre></div><p>从源码可以看出，第1、2行计算将要put进的键值对的数组的位置i。第4行判断加入的key是否和以table[i]为链表头的链表中所有的键值对有重复，若重复则替换value并返回旧值，若没有重复则调用addEntry方法，上面对这个方法的逻辑已经介绍过了。</p> <p>至此HashMap的put操作已经介绍完毕了。</p> <h2 id="_4-hashmap的get操作"><a href="#_4-hashmap的get操作" aria-hidden="true" class="header-anchor">#</a> 4. HashMap的get操作</h2> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	   <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    
	       <span class="token keyword">return</span> <span class="token function">getForNullKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	   <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span><span class="token function">indexFor</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	            <span class="token class-name">Object</span> k<span class="token punctuation">;</span>    
	            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
	                <span class="token keyword">return</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>    
	        <span class="token punctuation">}</span>    
	     <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    
	 <span class="token punctuation">}</span>    
	   
	 <span class="token keyword">private</span> <span class="token class-name">V</span> <span class="token function">getForNullKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    
	      <span class="token keyword">return</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>    
	     <span class="token punctuation">}</span>    
	     <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    
	 <span class="token punctuation">}</span>    
</code></pre></div><p>如果了解了前面的put操作，那么这里的get操作逻辑就很容易理解了，源码中的逻辑已经非常非常清晰了。</p> <p>需要注意的只有当找不到对应value时，返回的是null。或者value本身就是null。这是可以通过containsKey()来具体判断。</p> <p>了解了上面HashMap的put和get操作原理，可以通过下面这个小例题进行知识巩固，题目是打印在数组中出现n/2以上的元素，我们便可以使用HashMap的特性来解决。</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashMapTest</span> <span class="token punctuation">{</span>    
	    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	        <span class="token keyword">int</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    
	        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>a<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    
	            <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    
	                <span class="token keyword">int</span> tmp <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	                tmp<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>    
	                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	             <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    
	                 map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	             <span class="token punctuation">}</span>    
	         <span class="token punctuation">}</span>    
	         <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
	 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> s <span class="token operator">:</span> set<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
	             <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">&gt;=</span>a<span class="token punctuation">.</span>length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    
	                 <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	             <span class="token punctuation">}</span>    
	         <span class="token punctuation">}</span>  
	     <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>    
</code></pre></div><h2 id="_5-hashmap和hashtable的对比"><a href="#_5-hashmap和hashtable的对比" aria-hidden="true" class="header-anchor">#</a> 5. HashMap和HashTable的对比</h2> <p>HashTable和HashMap采用相同的存储机制，二者的实现基本一致，不同的是：</p> <p>（1）HashMap是非线程安全的，HashTable是线程安全的，内部的方法基本都经过synchronized修饰。</p> <p>（2）因为同步、哈希性能等原因，性能肯定是HashMap更佳，因此HashTable已被淘汰。</p> <p>（3） HashMap允许有null值的存在，而在HashTable中put进的键值只要有一个null，直接抛出NullPointerException。</p> <p>（4）HashMap默认初始化数组的大小为16，HashTable为11。前者扩容时乘2，使用位运算取得哈希，效率高于取模。而后者为乘2加1，都是素数和奇数，这样取模哈希结果更均匀。</p> <p>这里本来我没有仔细看两者的具体哈希算法过程，打算粗略比较一下区别就过的，但是最近师姐面试美团移动开发时被问到了稍微具体一些的算法过程，我也是醉了…不过还是恭喜师姐面试成功，起薪20W，真是羡慕，希望自己一年后找工作也能顺顺利利的。</p> <p>言归正传，看下两种集合的hash算法。看源码也不难理解。</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token comment">//HashMap的散列函数，这里传入参数为键值对的key  </span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token keyword">int</span> h<span class="token punctuation">;</span>  
	    <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>   
	<span class="token comment">//返回hash值的索引，h &amp; (length-1)操作等价于 hash % length操作， 但&amp;操作性能更优  </span>
	<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">indexFor</span><span class="token punctuation">(</span><span class="token keyword">int</span> h<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
	    <span class="token comment">// length must be a non-zero power of 2  </span>
	    <span class="token keyword">return</span> h <span class="token operator">&amp;</span> <span class="token punctuation">(</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	   
	<span class="token comment">//HashTable的散列函数直接在put方法里实现了  </span>
	<span class="token keyword">int</span> hash <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span> <span class="token operator">%</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>  
</code></pre></div><h2 id="_6-hashtable和concurrenthashmap的对比"><a href="#_6-hashtable和concurrenthashmap的对比" aria-hidden="true" class="header-anchor">#</a> 6. HashTable和ConCurrentHashMap的对比</h2> <p>先对ConcurrentHashMap进行一些介绍吧，它是线程安全的HashMap的实现。</p> <p>HashTable里使用的是synchronized关键字，这其实是对对象加锁，锁住的都是对象整体，当Hashtable的大小增加到一定的时候，性能会急剧下降，因为迭代时需要被锁定很长的时间。</p> <p>ConcurrentHashMap算是对上述问题的优化，其构造函数如下，默认传入的是16，0.75，16。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> paramInt1<span class="token punctuation">,</span> <span class="token keyword">float</span> paramFloat<span class="token punctuation">,</span> <span class="token keyword">int</span> paramInt2<span class="token punctuation">)</span>  <span class="token punctuation">{</span>    
        <span class="token comment">//…  </span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
        <span class="token keyword">while</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> paramInt2<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
          <span class="token operator">++</span>i<span class="token punctuation">;</span>    
          j <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
        <span class="token punctuation">}</span>    
        <span class="token keyword">this</span><span class="token punctuation">.</span>segmentShift <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    
         <span class="token keyword">this</span><span class="token punctuation">.</span>segmentMask <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
         <span class="token keyword">this</span><span class="token punctuation">.</span>segments <span class="token operator">=</span> <span class="token class-name">Segment</span><span class="token punctuation">.</span><span class="token function">newArray</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>    
         <span class="token comment">//…  </span>
         <span class="token keyword">int</span> k <span class="token operator">=</span> paramInt1 <span class="token operator">/</span> j<span class="token punctuation">;</span>    
         <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">*</span> j <span class="token operator">&lt;</span> paramInt1<span class="token punctuation">)</span>    
           <span class="token operator">++</span>k<span class="token punctuation">;</span>    
         <span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
         <span class="token keyword">while</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;</span> k<span class="token punctuation">)</span>    
           l <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
         
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i1 <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i1<span class="token punctuation">)</span>    
           <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">[</span>i1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Segment</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> paramFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>    
       <span class="token punctuation">}</span>    
       
     <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> paramK<span class="token punctuation">,</span> <span class="token class-name">V</span> paramV<span class="token punctuation">)</span>  <span class="token punctuation">{</span>    
         <span class="token keyword">if</span> <span class="token punctuation">(</span>paramV <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
         <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>paramK<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这里的hash函数和HashMap中的不一样  </span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">&gt;&gt;&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>segmentShift <span class="token operator">&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>segmentMask<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>paramK<span class="token punctuation">,</span> i<span class="token punctuation">,</span> paramV<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
     <span class="token punctuation">}</span>    
</code></pre></div><p>ConcurrentHashMap引入了分割(Segment)，上面代码中的最后一行其实就可以理解为把一个大的Map拆分成N个小的HashTable，在put方法中，会根据hash(paramK.hashCode())来决定具体存放进哪个Segment，如果查看Segment的put操作，我们会发现内部使用的同步机制是基于lock操作的，这样就可以对Map的一部分（Segment）进行上锁，这样影响的只是将要放入同一个Segment的元素的put操作，保证同步的时候，锁住的不是整个Map（HashTable就是这么做的），相对于HashTable提高了多线程环境下的性能，因此HashTable已经被淘汰了。</p> <h2 id="_7-hashmap和concurrenthashmap的对比"><a href="#_7-hashmap和concurrenthashmap的对比" aria-hidden="true" class="header-anchor">#</a> 7. HashMap和ConCurrentHashMap的对比</h2> <p>最后对这俩兄弟做个区别总结吧：</p> <p>（1）经过4.2的分析，我们知道ConcurrentHashMap对整个桶数组进行了分割分段(Segment)，然后在每一个分段上都用lock锁进行保护，相对于HashTable的syn关键字锁的粒度更精细了一些，并发性能更好，而HashMap没有锁机制，不是线程安全的。</p> <p>（2）HashMap的键值对允许有null，但是ConCurrentHashMap都不允许。</p> <p>至此对HashMap、HashTable以及ConCurrentHashMap异同比较总结完毕。</p> <p>转载请出自出处：<a href="http://blog.csdn.net/seu_calvin/article/details/52653711" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/seu_calvin/article/details/52653711<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: : </span> <span class="time">9/24/2020, 10:59:43 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/java/collection/list-remove.html" class="prev">
          删除list元素的四种方法(remove)
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.964429b0.js" defer></script><script src="/assets/js/2.8644fcbd.js" defer></script><script src="/assets/js/21.e3c2fe27.js" defer></script>
  </body>
</html>
